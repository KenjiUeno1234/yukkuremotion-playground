# ゆっくり実況動画作成 実行手順書

このドキュメントは、**input.md** に記載された原稿から、Remotionでゆっくり実況動画を作成する手順を説明します。

## 前提条件

- Node.js v22以上がインストール済み
- VOICEPEAK がインストール済み（パス: C:\\voicepeak\\VOICEPEAK\\voicepeak.exe）
- 依存パッケージがインストール済み（npm install 実行済み）
- BGMファイル（Floraria.mp3）が `public/bgm/` に配置済み

---

## 動画作成の全体フロー

```
input.md（原稿：通常のテキスト形式）
    ↓ npm run convert:movieyou
movieyou.md（動画用台本：55文字以内で分割）自動生成
    ↓ npm run convert:input
transcripts/myvideo.tsx（TypeScript台本）自動生成
    ↓ npm run generate:voicepeak
音声ファイル生成（VOICEPEAK）
    ↓ npm run update:audio-durations ⚠️ 必須
音声長 + fromFramesMap 設定（音声重複防止）
    ↓ npm start
プレビュー確認（ここまで実施）
```

**重要:** `npm run update:audio-durations` は必ず実行してください。このステップで `fromFramesMap` が生成され、各セリフが順次再生されるようになります。

---

## ステップ1: movieyou.md（動画用台本）の生成

### 1-1. input.md から movieyou.md への変換

以下のコマンドで、**input.md** から **movieyou.md** を自動生成します：

```bash
npm run convert:movieyou
```

このコマンドは、input.md を読み取り、以下の処理を行います：
- 55文字以内で句読点（。、）で分割
- 「」は文字数カウントから除外
- 全ての話者を「ayumi」に設定
- **マークダウン形式**で movieyou.md を生成

生成例：
```markdown
## セクション1

### ayumi
けんじ、最近よく「自社データを使うならRAG一択でしょ？」って早とちりしちゃう人が多いみたいなんだけど、

### ayumi
そこにちょっと待ったって言いたいの。

### ayumi
今回の話はね、その思い込みに対して、一度立ち止まって考えてみようっていう提案なんだ。
```

### 1-2. movieyou.md のフォーマット

- `##` で各セクションを定義（段落ごとに自動採番）
- `###` で話者を指定（話者は常に「ayumi」）
- 話者の直後の行にセリフを記述（55文字以内）

---

## ステップ2: TypeScript台本ファイルの生成

### 2-1. movieyou.md から transcripts/myvideo.tsx への変換

以下のコマンドで、**movieyou.md** から **transcripts/myvideo.tsx** を自動生成します：

```bash
npm run convert:input
```

このコマンドは：
- movieyou.md を読み取る
- 各セリフにUUIDを自動生成
- TypeScript形式の台本ファイルを作成

生成されるファイルの例：

```typescript
export const MyVideoConfig: VideoConfig = {
  sections: [
    {
      title: 'イントロダクション',
      talks: [
        {
          text: '近年のLLMは長文入力に対応しています。',
          speaker: 'ayumi',
          id: '5d64484cf146478aaae76a30fc4d31fa',
          audioDurationFrames: 0,
        },
        // ...
      ],
      // ...
    },
  ],
};
```

---

## ステップ3: 音声ファイルの生成

### 3-1. VOICEPEAKで音声を生成

以下のコマンドを実行して、全てのセリフの音声ファイルを生成します：

```bash
npm run generate:voicepeak
```

このコマンドは：
- **transcripts/myvideo.tsx** からセリフを読み取る
- 各セリフごとにVOICEPEAKで音声生成
- **public/audio/yukkuri/{id}.wav** として保存
- 既存ファイルは自動的にスキップ

### 3-2. 音声設定のカスタマイズ

音声の設定を変更する場合は、**scripts/generateVoicepeakAudios.ts** を編集：

```typescript
// ayumiの声設定
const AYUMI_CONFIG = {
  voice: 'Haruno Sora',
  speed: 120,
  pitch: -30,
  pause: 130,
  volume: 80,
  emotion: 'happy=30,sad=10,angry=0,whisper=20,cool=15',
};
```

### 3-3. 音声の長さを台本に反映（重要）

音声ファイル生成後、以下のコマンドで音声の長さを台本に反映します：

```bash
npm run update:audio-durations
```

**⚠️ このステップは必須です！** スキップすると音声が重複して再生されます。

このコマンドは以下を実行します：

1. **`audioDurationFrames`の設定**
   - 生成された音声ファイルの長さを取得
   - 各セリフの音声長をフレーム数に変換して設定

2. **`fromFramesMap`の自動生成（音声重複防止のために必須）**
   - 各セリフの開始フレーム位置を自動計算
   - 例: `{"0":30,"1":584}` → 1つ目は30フレーム目から、2つ目は584フレーム目から開始
   - このマップがないと、全セリフが同時に再生されて音声が重複します

3. **`totalFrames`の計算**
   - セクション全体の総フレーム数を計算
   - プレビューと動画レンダリングに必要な情報を設定

**生成例:**
```typescript
fromFramesMap: {"0":30,"1":584},  // ← 各セリフの開始位置
totalFrames: 1359,                 // ← セクション全体の長さ
talks: [
  {
    text: '...',
    audioDurationFrames: 529,      // ← 音声の長さ
  },
  // ...
]
```

### 3-4. 強制再生成

既存音声を削除して再生成したい場合：

```bash
rm -rf public/audio/yukkuri
npm run generate:voicepeak
npm run update:audio-durations
```

---

## ステップ4: プレビューで確認

### 4-1. プレビューサーバーの起動

```bash
npm start
```

ブラウザで以下のURLを開きます：
- **http://localhost:3000**

### 4-2. プレビューでの確認事項

✅ 音声が正しく再生されるか
✅ 字幕が表示されるか（55文字以内で分割されているか）
✅ キャラクターが表示されるか
✅ タイミングがずれていないか

---

## クイックスタート（要約）

```bash
# 前提: input.md に原稿を配置済み

# 1. movieyou.md を生成（input.mdから55文字以内で分割）
npm run convert:movieyou

# 2. TypeScript台本を生成
npm run convert:input

# 3. 音声ファイルを生成
npm run generate:voicepeak

# 4. 音声の長さを台本に反映（⚠️ 必須: スキップすると音声が重複します）
npm run update:audio-durations

# 5. プレビュー確認
npm start
```

**⚠️ 重要な注意事項:**
- **ステップ4 (`npm run update:audio-durations`) は必ず実行してください**
- このステップをスキップすると、`fromFramesMap`が生成されず、全セリフが同時に再生されて音声が重複します
- 音声ファイルを再生成した場合は、必ずステップ4を再実行してください
- input.mdは段落ごとにセクション分けされ、55文字以内で自動分割されます

---

## トラブルシューティング

### 音声が重複して再生される

**症状:**
- 複数のセリフが同時に再生され、音声が重なって聞こえる
- 霊夢と魔理沙の声が同時に流れる

**原因:**
- `transcripts/myvideo.tsx` の `fromFramesMap` が空オブジェクト `{}` になっている
- `npm run update:audio-durations` を実行していない、または実行し忘れた

**解決方法:**
```bash
# 音声の長さとfromFramesMapを再生成
npm run update:audio-durations
```

**確認方法:**
[transcripts/myvideo.tsx](transcripts/myvideo.tsx) を開いて、以下のように `fromFramesMap` に値が設定されているか確認：

```typescript
fromFramesMap: {"0":30,"1":584},  // ✅ 正しい
```

以下の場合は修正が必要：
```typescript
fromFramesMap: {},  // ❌ 空オブジェクト → 音声が重複する
```

---

### 音声が生成されない

- VOICEPEAKのパスを確認: `C:\\voicepeak\\VOICEPEAK\\voicepeak.exe`
- `scripts/generateVoicepeakAudios.ts` の `VOICEPEAK_PATH` を修正

### プレビューでエラー

- `public/audio/yukkuri/` に音声ファイルがあるか確認
- ブラウザのコンソールでエラー内容を確認

---

## 参考ファイル

- **台本サンプル**: transcripts/firstvideo.tsx
- **音声生成スクリプト**: scripts/generateVoicepeakAudios.ts
- **動画設定型定義**: src/yukkuri/yukkuriVideoConfig.ts

---

## BGM設定

### BGMファイルの準備

動画に背景音楽を追加するには、BGMファイルを **public/bgm/** フォルダに配置します。

**デフォルト設定：**
- BGMファイル: `Floraria.mp3`
- 配置場所: `public/bgm/Floraria.mp3`
- 音量: 20%（0.2）

### BGMの自動設定

以下のスクリプトでは、自動的にBGMが追加されます：

1. **convertMovieyouToTranscript.ts**: TypeScript台本生成時にBGM設定を追加
2. **updateMyVideoAudioDurations.ts**: 音声の長さ更新時にBGM設定を保持

### BGM設定のカスタマイズ

BGMを変更したい場合は、以下のファイルを編集してください：

**transcripts/myvideo.tsx** (手動編集):
```typescript
{
  title: 'セクションタイトル',
  bgmSrc: 'bgm/Floraria.mp3',  // BGMファイルのパス（先頭のスラッシュなし）
  bgmVolume: 0.2,               // 音量（0.0〜1.0）
  // ...
}
```

**scripts/convertMovieyouToTranscript.ts** (自動生成用):
```typescript
bgmSrc: 'bgm/Floraria.mp3',  // 先頭のスラッシュなし
bgmVolume: 0.2,
```

**推奨音量：**
- `0.1` - 10%（非常に控えめ）
- `0.2` - 20%（デフォルト、推奨）
- `0.3` - 30%（やや大きめ）

---

## カスタムレイアウト設定

### 背景画像の設定

動画に背景画像を追加するには、以下の手順に従ってください：

#### 1. 背景画像ファイルの配置

背景画像を **public/BACKGROUND_LAYER/** フォルダに配置します。

**推奨設定：**
- 画像形式: JPG、PNG
- 解像度: 1920x1080 以上
- アスペクト比: 16:9

**例：**
```
public/BACKGROUND_LAYER/sora-yoru.jpg
```

#### 2. transcripts/myvideo.tsx での設定

**transcripts/myvideo.tsx** を編集して、背景画像を追加：

```typescript
export const MyVideoConfig: VideoConfig = {
  sections: [
    {
      title: 'セクションタイトル',
      bgmSrc: 'bgm/Floraria.mp3',
      bgmVolume: 0.2,
      backgroundImage: 'BACKGROUND_LAYER/sora-yoru.jpg',  // 背景画像のパス
      // ...
    }
  ],
};
```

**注意事項：**
- パスは `public/` からの相対パスで指定（先頭のスラッシュなし）
- `backgroundImage` が設定されている場合、背景色の代わりに画像が表示されます

---

### カスタム人物画像の設定

デフォルトのゆっくりキャラクターの代わりに、カスタム人物画像を使用できます。

#### 1. 人物画像ファイルの配置

人物画像を **public/jinbutu/** フォルダに配置します。

**推奨設定：**
- 画像形式: PNG（透過背景推奨）
- サイズ: 全身が収まるように適切なサイズ
- アスペクト比: 人物の縦横比に応じて調整

**例：**
```
public/jinbutu/目を開けている顔.png
public/jinbutu/目を閉じている顔.png
```

#### 2. transcripts/myvideo.tsx での設定

**transcripts/myvideo.tsx** を編集して、人物画像を追加：

```typescript
export const MyVideoConfig: VideoConfig = {
  sections: [
    {
      title: 'セクションタイトル',
      bgmSrc: 'bgm/Floraria.mp3',
      bgmVolume: 0.2,
      backgroundImage: 'BACKGROUND_LAYER/sora-yoru.jpg',
      customReimuImagePath: 'jinbutu/目を開けている顔.png',  // 右側に表示される人物画像
      customMarisaImagePath: 'jinbutu/目を閉じている顔.png',  // （オプション）
      // ...
    }
  ],
};
```

**動作：**
- `customReimuImagePath` が設定されている場合、画面右側に1人の人物が表示されます
- デフォルトのゆっくりキャラクター（霊夢・魔理沙）は非表示になります
- カスタム人物画像は静止画として表示され、ふわふわアニメーションは適用されません

**サイズ調整：**
- 人物画像のサイズは自動的に380px幅に調整されます
- 配置位置: 画面右下（`right: 60px`, `bottom: 120px`）

---

### 字幕スタイルのカスタマイズ

字幕のスタイルは以下のファイルで設定されています：

**src/Subtitle/SubtitleBackground.tsx**
```typescript
const jimakuBackground: React.CSSProperties = {
  backgroundColor: '#062722',  // 背景色（濃い緑）
  width: '100%',
  paddingLeft: '40px',
  paddingRight: '40px',
};
```

**src/Subtitle/Subtitle.tsx**
```typescript
const subtitle: React.CSSProperties = {
  fontFamily: 'GenshinGothic',
  fontSize: 48,
  fontWeight: 'bold',
  color: '#DEFFEE',  // フォント色（明るい緑）
  textAlign: 'left',
};
```

**カスタマイズポイント：**
- `backgroundColor`: 字幕背景の色
- `fontSize`: フォントサイズ（デフォルト: 48px）
- `color`: テキストの色
- `textAlign`: テキストの配置（left/center/right）

---

## まとめ

このワークフローにより、**input.md に配置した原稿** から **ゆっくり実況動画のプレビュー** を簡単に作成できます！

1. **input.md** に原稿を配置（ユーザーが事前に準備）
2. **movieyou.md** で55文字以内に自動分割（話者: ayumi、句読点で区切り）
3. **TypeScript台本** で動画設定を自動生成
4. **VOICEPEAK** で音声を自動生成
5. **Remotion** でプレビュー確認
6. **カスタムレイアウト** で背景画像・人物画像を設定（オプション）

**注意**: 動画のレンダリング（MP4ファイル出力）は実施しません。プレビュー確認までを実施します。

以上で完了です！
