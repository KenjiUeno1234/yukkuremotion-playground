# 口パク機能の検証レポート

**作成日**: 2025-11-20
**対象**: スライドショー動画の口パク機能

---

## 実装の改善内容

### 1. 口パクマップ生成の最適化 (SlideshowVideo.tsx)

**問題点**:
- 口パクマップの生成ロジックは正しかったが、デバッグ情報が不足

**改善内容**:
- コンソールログを追加して、口パクマップの生成範囲を確認可能に
- 各スライドの開始フレームと終了フレームをログ出力

```typescript
console.log(`口パクマップ生成: ${frames.length}フレーム, 開始=${startFrame}, 終了=${currentNarrationFrame - 1}`);
```

### 2. 口パクマップ検索の効率化 (YukkuriFace.tsx)

**問題点**:
- `indexOf` による線形探索が非効率（O(n)）
- 大量のフレーム（3744フレーム）で毎フレーム検索すると重い

**改善前のコード**:
```typescript
const frameIndex = kuchipakuMap.frames.indexOf(frame);
if (frameIndex !== -1) {
  return kuchipakuMap.amplitude[frameIndex];
}
```

**改善後のコード**:
```typescript
const firstFrame = kuchipakuMap.frames[0];
const lastFrame = kuchipakuMap.frames[kuchipakuMap.frames.length - 1];

if (frame >= firstFrame && frame <= lastFrame) {
  const index = frame - firstFrame;
  if (index >= 0 && index < kuchipakuMap.amplitude.length) {
    return kuchipakuMap.amplitude[index];
  }
}
```

**改善効果**:
- 計算量: O(n) → O(1)
- フレーム配列が連続している特性を利用
- 開始/終了タイミングが正確に反映される

---

## 口パクパターンの仕様

### パターン詳細

```
サイクル: 3フレーム周期
パターン: 開→開→閉

フレーム 0: 口を開く (amplitude = 1)
フレーム 1: 口を開く (amplitude = 1)
フレーム 2: 口を閉じる (amplitude = 0)
フレーム 3: 口を開く (amplitude = 1)
...
```

### 適用範囲

- **開始**: 各ナレーションの最初のフレーム（startFrame）
- **終了**: 各ナレーションの最後のフレーム（startFrame + audioDurationFrames - 1）
- **ナレーション間**: 次のナレーション開始まで口を閉じる

---

## 検証方法

### 自動検証（ブラウザコンソール）

ブラウザの開発者ツール（F12）を開き、以下のログを確認：

```
口パクマップ生成: 290フレーム, 開始=0, 終了=289
口パクマップ生成: 489フレーム, 開始=290, 終了=778
口パクマップ生成: 467フレーム, 開始=779, 終了=1245
...
```

**期待される結果**:
- 各スライドの口パクマップが正しい範囲で生成されている
- 開始フレームと終了フレームが連続している

### 手動検証

1. **開始タイミング**
   - [ ] スライドS001の最初のナレーション開始時に口が動き始める
   - [ ] スライドS002の最初のナレーション開始時に口が動き始める
   - [ ] すべてのスライドで同様に確認

2. **終了タイミング**
   - [ ] 各ナレーション終了時に口が閉じる
   - [ ] 次のナレーション開始までは口が閉じたまま

3. **複数ナレーション**
   - [ ] S001: 2つのナレーションで各々口パクが動作
   - [ ] S002: 3つのナレーションで各々口パクが動作
   - [ ] ナレーション間の切り替えがスムーズ

4. **パターンの自然さ**
   - [ ] 口パクが3フレーム周期で開閉している
   - [ ] 動きが機械的すぎない
   - [ ] 音声とタイミングが合っている

---

## データで見る口パク実装

### スライドS001の例

```typescript
{
  id: "S001",
  narrations: [
    {
      text: "「自社データならRAGでしょ」と言われがちですが、実はそうとも限りません。",
      voicePath: "voices/S001-1.wav",
      audioDurationFrames: 176  // 5.87秒
    },
    {
      text: "まずは、その思い込みをそっとほどいていきましょう。",
      voicePath: "voices/S001-2.wav",
      audioDurationFrames: 114  // 3.80秒
    }
  ],
  totalDurationFrames: 290  // 9.67秒
}
```

**口パクマップ**:
- フレーム 0-175: S001-1.wav 再生中（口パク動作）
- フレーム 176-289: S001-2.wav 再生中（口パク動作）
- 合計290フレーム、すべてで口パク動作

### 全体の統計

| スライド | ナレーション数 | 総フレーム数 | 口パク動作フレーム |
|---------|--------------|-------------|------------------|
| S001 | 2 | 290 | 290 (100%) |
| S002 | 3 | 489 | 489 (100%) |
| S003 | 3 | 467 | 467 (100%) |
| S004 | 3 | 432 | 432 (100%) |
| S005 | 2 | 333 | 333 (100%) |
| S006 | 5 | 500 | 500 (100%) |
| S007 | 3 | 292 | 292 (100%) |
| S008 | 5 | 470 | 470 (100%) |
| S009 | 3 | 471 | 471 (100%) |
| **合計** | **29** | **3744** | **3744 (100%)** |

**結論**: すべてのフレームで口パクが動作するはず

---

## トラブルシューティング

### 問題: 一部のフレームで口パクしない

**確認事項**:
1. ブラウザコンソールで口パクマップのログを確認
2. フレーム範囲が正しいか確認
3. amplitude配列の長さがframes配列と一致しているか確認

**解決方法**:
- ブラウザをハードリフレッシュ（Ctrl + Shift + R）
- `npm start` を再起動

### 問題: 口パクのタイミングがずれる

**原因**: 音声ファイルの長さとaudioDurationFramesが一致していない

**確認方法**:
```bash
npx ts-node scripts/generateSlideshowConfig.ts
```

**解決方法**: 音声ファイルを再生成し、設定ファイルを再生成

---

## 技術的な実装詳細

### フレーム計算式

```typescript
// スライドの開始フレーム
startFrame = 前のスライドまでの累積フレーム数

// ナレーションNの開始フレーム
narrationStartFrame = startFrame + (前のナレーションの累積フレーム数)

// 口パクマップのインデックス
index = 現在のフレーム - 口パクマップの最初のフレーム
```

### パフォーマンス

**改善前**:
- フレームごとに線形探索: O(n) × フレーム数
- 3744フレーム × 平均1872要素 ≈ 700万回の比較

**改善後**:
- フレームごとに定数時間計算: O(1) × フレーム数
- 3744フレーム × 4回の計算 ≈ 15,000回の計算
- **約467倍の高速化**

---

## まとめ

### 実装済み機能

✅ ナレーション開始時に口パク開始
✅ ナレーション終了時に口パク終了
✅ 複数ナレーション対応（29ナレーション）
✅ 3フレームサイクルの自然な口パクパターン
✅ 効率的な検索アルゴリズム（O(1)）
✅ デバッグログ出力

### 期待される動作

- すべてのナレーション（29個）で口パクが正確に動作
- 開始/終了タイミングが音声と完全に同期
- パフォーマンスの問題なし
- ブラウザコンソールで検証可能

### 次のステップ

1. ブラウザで http://localhost:3001 を開く
2. "Slideshow" を選択
3. 再生して各スライドの口パクを確認
4. ブラウザコンソールでログを確認
5. 問題があれば報告

---

**検証ステータス**: ✅ 実装完了・検証待ち
